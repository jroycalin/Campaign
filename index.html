<!doctype html>
<html lang="en">
<head>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scratch & Win</title>

<style>
body {
  background: linear-gradient(135deg, #ffffff, #ffecec);
  font-family: 'Roboto', Arial, sans-serif;
  margin: 0;
  padding: 10px;
  color: #333;
}

/* Responsive container */
.container {
  max-width: 600px;
  margin: 0 auto;
  padding: 16px;
  box-sizing: border-box;
}

/* Logo */
.logo {
  text-align:center; 
  margin:20px 0;
}
.logo img {
  max-width: 160px;
  height: auto;
}

/* Banner */
.banner {
  background: url('https://mobixpress.in/assets/images/banner.jpg') no-repeat center center/cover;
  width: 100%;
  height: 10vh;
  min-height: 180px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  animation: fadeIn 1.5s ease-in-out;
}

.banner-overlay {
  background: rgba(255, 0, 0, 0.35);
  width: 100%;
  height: 100%;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: #fff;
}

.banner-overlay h3 {
  font-size: clamp(18px, 4vw, 28px);
  font-weight: 700;
  animation: slideDown 1s ease-in-out;
  margin: 0;
}

.banner-overlay p {
  font-size: clamp(14px, 3vw, 20px);
  animation: fadeInUp 1.2s ease-in-out;
  margin: 8px 0 0;
}
/* BranchDetails */
.branch-details {
  background: #fff;
  border: 2px solid #E1302F;
  padding: 20px;
  border-radius: 12px;
  margin: 20px auto;
  max-width: 500px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.branch-details h2 {
  font-size: 22px;
  color: #E1302F;
  margin-bottom: 15px;
  text-align: center;
}

.branch-details ul {
  list-style: none;
  padding: 0;
}

.branch-details li {
  font-size: 16px;
  margin: 10px 0;
  display: flex;
  align-items: center;
}

.branch-details i {
  color: #E1302F;
  margin-right: 10px;
  font-size: 18px;
}


/* Form */
form {
  margin: 20px 0;
}
input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 16px;
  box-sizing: border-box;
}
button {
  background: #E1302F;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 14px;
  width: 100%;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
}
button:hover {
  background: #c1272d;
}
button:disabled {
  background: #ccc;
}

/* Scratch Card */
#scratchCanvas {
  width: 100%;
  max-width: 350px;
  height: auto;
  aspect-ratio: 7/3; /* keep shape */
  border: 2px solid #ccc;
  border-radius: 8px;
  margin: 20px auto;
  
  cursor: pointer;
}
#scratchCanvas.hidden { display: none !important; }

/* Result */
.result {
  font-size: clamp(18px, 5vw, 24px);
  font-weight: bold;
  margin-top: 15px;
  text-align: center;
}
.result strong {
  color: #E1302F;
  font-size: clamp(20px, 6vw, 28px);
  display: inline-block;
  margin-top: 10px;
}

/* Animations */
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
@keyframes slideDown { from {transform: translateY(-40px); opacity:0;} to {transform: translateY(0); opacity:1;} }
@keyframes fadeInUp { from {transform: translateY(40px); opacity:0;} to {transform: translateY(0); opacity:1;} }

.hidden { display: none; }

/* Loader overlay */
#loader {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.85);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 6px solid #eee;
  border-top: 6px solid #E1302F;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 12px;
}

@keyframes spin {
  0%   { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.hidden {
  display: none !important;
}

/* Modal Background */
.modal {
  display: flex;
  align-items: center;
  justify-content: center;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 10000;
}

/* Hide modal by default */
.modal.hidden { display: none !important; }

/* Modal Box */
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  position: relative;
  animation: fadeIn 0.3s ease-in-out;
}

/* Close Button */
.close {
  position: absolute;
  top: 10px;
  right: 16px;
  font-size: 22px;
  font-weight: bold;
  color: #E1302F;
  cursor: pointer;
}
.close:hover { color: #000; }

</style>
</head>

<body>
<div class="container">
  <!-- Logo -->
  <div class="logo">
    <img src="logo.png" alt="Mobixpress">
  </div>
  <section class="branch-details">
  <h2>üìç Mobixpress Nabadwip Store</h2>
  </section> 

  <!-- Banner -->
  <div class="banner">
    <div class="banner-overlay">
      <h3>üéâ Scratch & Win with Mobixpress üéâ</h3>
      <p id="message">Exciting prizes are waiting for you!</p>
    </div>
  </div>

  <!-- Form -->
  <form id="userForm">
    <input type="text" id="name" placeholder="Your Name" required />
    <input type="tel" id="mobile" placeholder="Mobile Number *" pattern="[0-9]{10}" required><br>
    <input type="email" id="email" placeholder="Your Email" required />
    <button type="submit">Start Playing</button>
  </form>

  <!-- Scratch Canvas -->
  <canvas id="scratchCanvas" class="hidden"></canvas>
  <div id="result" class="result hidden"></div>
</div>

<!-- Loader -->
<div id="loader" class="hidden">
  <div class="spinner"></div>
  <p>Checking your entry...</p>
</div>

<p style="text-align:center; margin-top:20px;">
  <a href="#" id="termsLink">üìú Terms & Conditions</a>
</p>


<!-- Branch Details Section -->
<section class="branch-details">
  <ul>
    <li><i class="fas fa-map-marker-alt"></i> 123 Main Road, Nabadwip, West Bengal</li>
    <li><i class="fas fa-phone-alt"></i> <a href="tel:+918388990699">+91 83889 90699</a></li>
    <li><i class="fas fa-envelope"></i> <a href="mailto:info@mobixpress.in">info@mobixpress.in</a></li>
    <li><i class="fas fa-clock"></i> Mon‚ÄìSat: 10:00 AM ‚Äì 8:00 PM</li>
  </ul>
</section>

<!-- Terms & Conditions Modal -->
<div id="termsModal" class="modal hidden">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Terms & Conditions</h2>
    <p>
      You need to come to our <strong>Nabadwip branch</strong> within the given date range<strong>[10th September 2025 to 25th September 2025]</strong><br><br>
      - Make a purchase in-store.<br>
      - Show the screenshot of your scratch prize along with the timestamp.<br>
      - Then, you can collect your prize üéÅ.<br><br>
      üìç Address: 123 Main Road, Nabadwip, West Bengal.
    </p>
  </div>
</div>

<script>

//const CLAIM_URL = "https://script.google.com/macros/s/AKfycbzvNAQZn6kjzwHuiViSjFM7gT6UaFY03JJz-HPMj5G7-XZoBqDjMXb3rDI6CVar-0stpA/exec"; // replace with your deployed Apps Script URL

const SHEET_URL = "https://script.google.com/macros/s/AKfycbzr372pKSe-voPvApCWkw6E5oXcP0H6l7PVQBLIi6DZFjCsYlf2lSTXt5dUFRGALSXepw/exec";  // doGet
const SAVE_URL  = "https://script.google.com/macros/s/AKfycbzupkP_aSANp39LWVOtEhxodmMYel9h0zdPtl-EOw-M9VKC1vnr2-KryMuHOQQ8oop4GA/exec";  // doPost (same script if both are enabled)

let user = {};
const canvas = document.getElementById("scratchCanvas");
const ctx = canvas.getContext("2d");
const resultEl = document.getElementById("result");
let prize = null;
let prizeClaimed = false;
let prizeList = [];


// Step 1: Fetch prize list
async function loadPrizes() {
      try {
        let res = await fetch(SHEET_URL);
        let data = await res.json();
        prizeList = data.prizes || [];
        console.log("Prizes loaded:", prizeList);
      } catch (err) {
        console.error("Error loading prizes", err);
      }
    }


//Check Mobile
async function checkMobile(mobile) {
  try {
    const url = `${SHEET_URL}?action=checkMobile&mobile=${encodeURIComponent(mobile)}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.exists === true;
  } catch (e) {
    console.error("checkMobile error:", e);
    return false;
  }
}

// Step 2: Pick prize locally
function pickPrize() {
  // filter only available prizes
  const available = prizeList.filter(p => p.count > 0);
  if (available.length === 0) return "Better luck Next time";

  // weighted random selection
  let total = available.reduce((sum, p) => sum + p.count, 0);
  let rand = Math.floor(Math.random() * total);
  for (let p of available) {
    if (rand < p.count) return p.item;
    rand -= p.count;
  }
  return null;
}

// Step 3: Save winner back
async function saveWinner(name, mobile, email, prize) {
 try {
        let code= Math.random().toString(36).substring(2,8);
        let payload = { name, mobile, email, prize , code };
        await fetch(SAVE_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });
      } catch(err) {
        console.error("Error saving winner", err);
      }
    }

function initScratch() {
  ctx.fillStyle = "#999";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.globalCompositeOperation = "destination-out";
  canvas.addEventListener("mousemove", scratch);
  canvas.addEventListener("touchmove", scratch);

  canvas.addEventListener("touchstart", e => {
  e.preventDefault(); // stop screen from scrolling
  isDrawing = true;
  lastX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
  lastY = e.touches[0].clientY - canvas.getBoundingClientRect().top;
}, { passive: false });

canvas.addEventListener("touchmove", e => {
  e.preventDefault(); // stop scrolling
  if (!isDrawing) return;
  const x = e.touches[0].clientX - canvas.getBoundingClientRect().left;
  const y = e.touches[0].clientY - canvas.getBoundingClientRect().top;
  scratchAt(x, y);
}, { passive: false });

canvas.addEventListener("touchend", () => {
  isDrawing = false;
}, { passive: false });
}

function scratch(e) {
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  ctx.beginPath();
  ctx.arc(x,y,15,0,Math.PI*2);
  ctx.fill();
  checkReveal();
}

function checkReveal() {
  const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let cleared = 0;
  for (let i=3;i<pixels.length;i+=4) if (pixels[i] === 0) cleared++;
  if (cleared / (pixels.length/4) > 0.5) 
	{
	prize = pickPrize();
	showPrize();
	}
}

function showPrize() {
  if (prizeClaimed) return;
  prizeClaimed = true;

  // stop further scratching
  canvas.removeEventListener("mousemove", scratch);
  canvas.removeEventListener("touchmove", scratch);
  ctx.globalCompositeOperation = "source-over";

  // hide the canvas decisively
  canvas.classList.add("hidden");
  canvas.style.display = "none";

  document.getElementById("message").classList.add("hidden");
  resultEl.innerHTML = `üéâ You have won üéâ<br/><strong>${prize}</strong>`;
  saveWinner(user.name, user.mobile, user.email, prize);
  resultEl.classList.remove("hidden");
  
  confetti({ particleCount: 180, spread: 80, origin: { y: 0.6 } });
}


document.getElementById("userForm").addEventListener("submit", async e => {
  e.preventDefault();
  user.name = document.getElementById("name").value;
  user.email = document.getElementById("email").value;
  user.mobile = document.getElementById("mobile").value;

  // Show loader while checking
  const loader = document.getElementById("loader");
  loader.classList.remove("hidden");
  //document.getElementById("loader").classList.remove("hidden");

 //Mobile Restriction
  let alreadyPlayed = await checkMobile(user.mobile);
  if (alreadyPlayed) {
    alert("This mobile number has already played. Please try with another number.");
    return; // stop further execution
  }

// Hide loader after check (success or fail)
    loader.classList.add("hidden");

  document.getElementById("userForm").classList.add("hidden");
  canvas.classList.remove("hidden");
  initScratch();
});

window.onload = loadPrizes;

// Terms & Conditions modal logic
const termsModal = document.getElementById("termsModal");
const termsLink = document.getElementById("termsLink");
const closeBtn  = termsModal.querySelector(".close");

termsLink.addEventListener("click", e => {
  e.preventDefault();
  termsModal.classList.remove("hidden");
});

closeBtn.addEventListener("click", () => {
  termsModal.classList.add("hidden");
});

// Close modal when clicking outside content
window.addEventListener("click", e => {
  if (e.target === termsModal) {
    termsModal.classList.add("hidden");
  }
});

</script>

</body>
</html>



